<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>hogsIA</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link href='mystyle.css' rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</head>
<body>
    <!--Navigation Bar-->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
              <img src="logo.png" >
            </div>
            <ul class="nav navbar-nav navbar-right ">
                <li class="inactive"><a href="about.php">about</a></li>
                <li class="inactive"><a href="contact.php">how it works</a></li>
                <form class="navbar-form navbar-left" role="search" name="jsform" id="jsform">
					<div class="form-group">
							<input type="text" id="searchbar" class="form-control" placeholder="Enter an Address">
					</div>
					 <button type="submit" class="btn btn-default">Submit</button>
				</form>
            </ul>
        </div>
    </nav>
    <div id='map'></div>
    
	<script>
		/*Initialize API and Map functions */
	   L.mapbox.accessToken = 'pk.eyJ1IjoidG9ycnliciIsImEiOiJjaXBiandkNXYwMDZhdDBtNzE0ZmQ5Y2U2In0.Hyoq2tSqLqCbNg_aZdDbaw';
		
        var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/torrybr.0cep34ef/{z}/{x}/{y}.png?access_token=' + L.mapbox.accessToken, {
		attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		});

		var map = L.map('map')
			.addLayer(mapboxTiles)
			.setView([42.3610, -93.955], 7);
			
		/* When a user searches, it calls this function */
		$('#jsform').submit(function(event) {
			var term = document.getElementById("searchbar").value;
			
			var bbox;
			var jsonQ;
			var url = "https://search.mapzen.com/v1/search?api_key=search-ktiqWXv&text=" + encodeURIComponent(term);
		
			/* Call MapZen Search API, Responsed w/ JSON, Parse Json, Zoom to location */
			$.getJSON(url,function(response) {
				var obj = JSON.parse(JSON.stringify(response));  
				var marker = new L.marker([obj.features[0].geometry.coordinates[1],obj.features[0].geometry.coordinates[0]])
				.addTo(map);	
				map.setView(new L.LatLng(obj.features[0].geometry.coordinates[1], obj.features[0].geometry.coordinates[0]),13);	
					
				/* bounding box that looks like: topLeftLat,topLeftLon,bottomRightLat,bottomRightLon, so we need to reorder the coordinates Leaflet returned */
				bbox = map.getBounds();
				console.log(bbox);
				var query = [
					bbox._northEast.lat,
					bbox._southWest.lng,
					bbox._southWest.lat,
					bbox._northEast.lng];
				/* Encode Boundry information in JSON format */
				 jsonQ = JSON.stringify(query);
				});
			event.preventDefault();
		});	
		
		/*Returns LIMIT OF 200 Data Points all Lat/Long obects in sqlite3 database and creates map marker,   */
		$.getJSON('returnAll.php',function(response) {
			var obj2 = JSON.parse(JSON.stringify(response));
			var array = [];
			for(var i = 0; i< response.length;i++) {
				if( obj2[i].Lat && obj2[i].Lng) {
					array.push([obj2[i].Lat,obj2[i].Lng,obj2[i].Name]);
				}
			}
			createMarkers(array);
		});
		
		/*creates map marker from an array */
		function createMarkers(array) {
			for (var i=0; i<array.length; i++) {
				var lon = array[i][0];
				var lat = array[i][1];
				var popupText = array[i][2];
            
				var markerLocation = new L.LatLng(lon, lat);
				var marker = new L.Marker(markerLocation);
				map.addLayer(marker);
         
				marker.bindPopup(popupText);
			}
		}
    </script>
</body>
</html>
